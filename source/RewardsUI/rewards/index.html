<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!-- <script src="index.js"></script> -->
</head>
<body>
    <h1>Welcome to the Rewards Dashboard</h1>
    <div>
        <h2>Reward Tiers</h2>
        <table border="1">
            <tr>
                <th>Rewards Tier<th>
                <th>Reward Points</th>
                <th>Rewards Tier Name</th>
            </tr>
            {% for reward in rewards_data %}
                <tr>
                    <td>{{ reward.tier }}<td>
                    <td>{{ reward.points }}</td>
                    <td>{{ reward.rewardName }}</td>
                </tr>
            {% endfor %}
        </table>
        <hr>
    </div>
    <div>
        <h2>Add orders</h2>
        <form>
            <label>Enter email address: </label><input type="text"/><br>
            <label>Enter order total: </label><input type="text"/><input type="button" value="Submit Order"/>
        </form>
        <hr>
    </div>
    <div>
        <h2>User Rewards</h2>
        <form>
            <label>Email address: </label><input id="email-search-box-js" type="text" value="bob@thebobsociety.com"/><input id="email-search-button-js" type="button" value="Search"/>
            <br />
            <img id="email-search-error-js" src="https://image.freepik.com/free-icon/signal-warning_318-28476.jpg" width="20px" style="display: none"/>
            <img id="email-search-spin-js" src="https://www.wallies.com/filebin/images/loading_apple.gif" width="20px" style="display: none"/>
            <label id="email-search-status-js" style="font-weight: bold; margin-left: 5px;"></label>
        </form>
        <table border="1" id="customer-results-js" style="display:none">
            <thead>
            <tr>
                <th>Email Address</th>
                <th>Reward Points</th>
                <th>Reward Tier</th>
                <th>Reward Tier Name</th>
                <th>Next Reward Tier</th>
                <th>Next Reward Tier Name</th>
                <th>Next Reward Tier Progress</th>
            </tr>
            </thead>
            <tbody>
                <tr>
                    <td id="customer-email-js">Email Address</td>
                    <td id="customer-points-js">Reward Points</td>
                    <td id="customer-tier-js">Reward Tier</td>
                    <td id="customer-tier-name-js">Reward Tier Name</td>
                    <td id="customer-next-tier-js">Next Reward Tier</td>
                    <td id="customer-next-tier-name-js">Next Reward Tier Name</td>
                    <td id="customer-next-tier-progress-js">Next Reward Tier Progressz</td>
                </tr>
            </tbody>
        </table>
    </div>
</body>
<script type="text/javascript">
var STATUS_SEARCHING    = 1;
var STATUS_FAILED       = 2;
var STATUS_SUCCESS      = 3;

function show_search_status(status) {
    if (status == STATUS_SEARCHING) {
        $('#email-search-error-js').hide();
        $('#customer-results-js').hide();
        $('#email-search-spin-js').show();
        $('#email-search-status-js').text('Searching....');
        $('#email-search-status-js').show();
    } else if (status == STATUS_FAILED) {
        $('#email-search-error-js').show();
        $('#email-search-spin-js').hide();
        $('#email-search-status-js').text('No Records Found.');
        $('#email-search-status-js').show();
    } else if (status == STATUS_SUCCESS) {
        $('#email-search-error-js').hide();
        $('#email-search-spin-js').hide();
        $('#email-search-status-js').hide();
        $('#customer-results-js').show();
    }
}


var search = function(){
    show_search_status(STATUS_SEARCHING);
    $('#email-search-button-js').prop('disabled', true);
    search_api = function(){
        email = $('input#email-search-box-js').val()
        return $.ajax({
            'url':'http://localhost:7050/users/' + email,
            'method':'GET',
        });
    };
    success = function(data) {
        console.log(data);
        // console.log();
        data = $.parseJSON(data);
        show_search_status(STATUS_SUCCESS);
        $('#customer-email-js').text(data[0]['email']);
        $('#customer-points-js').text(data[0]['points']);
        $('#customer-tier-js').text(data[0]['tier']);
        $('#customer-tier-name-js').text(data[0]['tier_name']);
        $('#customer-next-tier-js').text(data[0]['next_tier']);
        $('#customer-next-tier-name-js').text(data[0]['next_tier_name']);
        $('#customer-next-tier-progress-js').text(data[0]['next_tier_progress']);
    }
    failure = function() {
        show_search_status(STATUS_FAILED);
    }
    res = search_api().then(success, failure).then(function(){
        $('#email-search-button-js').prop('disabled', false);
    });
}

// Listen for both a click and an enter, and manage whether a request is ongoing by disabling/enabling the button
$('#email-search-button-js').click(function() {
    if (!$('#email-search-button-js').prop('disabled')) {
        search();
    }
});
$('#email-search-box-js').keypress(function(e) {
    if (e.keyCode == 13) {
        e.preventDefault();
        if (!$('#email-search-button-js').prop('disabled')) {
            search();
        }
    }
});
</script>
</html>
